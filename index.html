<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ESP32 Sprite Converter</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #00D9FF 0%, #39FF14 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }

        header p {
            font-size: 1.1em;
            color: #888;
        }

        .card {
            background: #111111;
            border: 2px solid #00D9FF;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
        }

        .card h2 {
            color: #00D9FF;
            margin-bottom: 15px;
            font-size: 1.5em;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 1em;
            cursor: pointer;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #00D9FF;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        .tab.active {
            color: #00D9FF;
            border-bottom-color: #00D9FF;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 3px dashed #00D9FF;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
            background: rgba(0, 217, 255, 0.05);
        }

        .upload-area:hover {
            background: rgba(0, 217, 255, 0.1);
            border-color: #39FF14;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
        }

        .upload-area.dragover {
            background: rgba(0, 217, 255, 0.15);
            border-color: #39FF14;
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(57, 255, 20, 0.4);
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: 2px solid #00D9FF;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            background: transparent;
            color: #00D9FF;
        }

        .btn-primary {
            background: #00D9FF;
            color: #000;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
        }

        .btn-primary:hover {
            background: #00FFFF;
            box-shadow: 0 0 25px rgba(0, 217, 255, 0.6);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #333;
            color: #00D9FF;
            border-color: #555;
        }

        .btn-secondary:hover {
            background: #444;
            border-color: #00D9FF;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
        }

        .btn-danger {
            background: #FF0055;
            color: #fff;
            border-color: #FF0055;
        }

        .btn-danger:hover {
            background: #FF3377;
            box-shadow: 0 0 15px rgba(255, 0, 85, 0.4);
        }

        .btn-success {
            background: #39FF14;
            color: #000;
            border-color: #39FF14;
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.4);
        }

        .btn-success:hover {
            background: #55FF33;
            box-shadow: 0 0 25px rgba(57, 255, 20, 0.6);
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .template-item {
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #0a0a0a;
        }

        .template-item:hover {
            border-color: #00D9FF;
            transform: translateY(-3px);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
        }

        .template-preview {
            width: 100%;
            aspect-ratio: 1;
            background: #1a1a1a;
            border: 2px solid #00D9FF;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .template-preview canvas {
            max-width: 100%;
            max-height: 100%;
            image-rendering: pixelated;
        }

        .template-item h3 {
            font-size: 0.9em;
            color: #00D9FF;
            margin-bottom: 5px;
        }

        .template-item p {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 10px;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .gallery-item {
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            background: #0a0a0a;
            transition: all 0.3s;
        }

        .gallery-item:hover {
            border-color: #00D9FF;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
        }

        .gallery-item canvas, .gallery-item img {
            max-width: 100%;
            image-rendering: pixelated;
            border: 2px solid #00D9FF;
            margin-bottom: 10px;
            background: #1a1a1a;
            display: block;
        }

        .gallery-item-info {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 10px;
        }

        .gallery-item-info strong {
            color: #00D9FF;
        }

        .gallery-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .gallery-actions .btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.85em;
        }

        .preview-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .preview-box {
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            background: #0a0a0a;
        }

        .preview-box h3 {
            margin-bottom: 10px;
            color: #00D9FF;
        }

        .preview-box canvas {
            max-width: 100%;
            image-rendering: pixelated;
            border: 2px solid #00D9FF;
            background: #1a1a1a;
        }

        .code-output {
            background: #0a0a0a;
            color: #39FF14;
            padding: 15px;
            border: 2px solid #00D9FF;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre;
            margin-top: 15px;
        }

        .info-box {
            background: rgba(0, 217, 255, 0.1);
            border-left: 4px solid #00D9FF;
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
        }

        .info-box p {
            margin-bottom: 5px;
            color: #ccc;
        }

        .info-box strong {
            color: #FFFF00;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #333;
            background: #0a0a0a;
            color: #fff;
            border-radius: 6px;
            font-size: 1em;
            transition: all 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #00D9FF;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
        }

        @media (max-width: 768px) {
            .preview-container {
                grid-template-columns: 1fr;
            }

            .template-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            header h1 {
                font-size: 1.8em;
            }

            .tabs {
                justify-content: center;
            }

            .tab {
                padding: 10px 16px;
                font-size: 0.9em;
            }
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: #111;
            border: 2px solid #00D9FF;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 40px rgba(0, 217, 255, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #00D9FF;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé® ESP32 Sprite Converter</h1>
            <p>Convert your pixel art to RGB565 C arrays for ESP32 displays</p>
        </header>

        <div class="card">
            <div class="tabs">
                <button class="tab active" data-tab="converter">Converter</button>
                <button class="tab" data-tab="templates">Templates</button>
                <button class="tab" data-tab="gallery">My Gallery</button>
            </div>

            <!-- Converter Tab -->
            <div class="tab-content active" id="converter">
                <h2>Upload Your Sprite</h2>
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" accept="image/png,image/jpeg,image/jpg">
                    <div class="upload-icon">üìÅ</div>
                    <h3>Click or Drag & Drop</h3>
                    <p>PNG or JPG images (max 480x320)</p>
                </div>

                <div id="previewSection" style="display: none;">
                    <div class="preview-container">
                        <div class="preview-box">
                            <h3>Original</h3>
                            <canvas id="originalCanvas"></canvas>
                        </div>
                        <div class="preview-box">
                            <h3>RGB565 Preview</h3>
                            <canvas id="rgb565Canvas"></canvas>
                        </div>
                    </div>

                    <div class="info-box" id="imageInfo"></div>

                    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="text" id="spriteName" placeholder="Sprite name (e.g., hero_idle)">
                        <button class="btn btn-primary" id="generateBtn">Generate Code</button>
                        <button class="btn btn-success" id="saveToGalleryBtn">Save to Gallery</button>
                    </div>

                    <div id="codeOutput" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; flex-wrap: wrap; gap: 10px;">
                            <h3 style="color: #00D9FF;">Generated C++ Code</h3>
                            <button class="btn btn-secondary" id="copyCodeBtn">Copy Code</button>
                        </div>
                        <div class="code-output" id="codeText"></div>
                    </div>
                </div>
            </div>

            <!-- Templates Tab -->
            <div class="tab-content" id="templates">
                <h2>Starting Templates</h2>
                <p style="color: #888; margin-bottom: 15px;">Download these templates to get started with the perfect dimensions for your ESP32 display</p>
                <div class="template-grid" id="templateGrid"></div>
            </div>

            <!-- Gallery Tab -->
            <div class="tab-content" id="gallery">
                <h2>My Sprite Gallery</h2>
                <div id="galleryContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed:', err));
        }

        // Global state
        let currentImageData = null;
        let currentRGB565Data = null;

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');

                if (tab.dataset.tab === 'gallery') {
                    loadGallery();
                }
            });
        });

        // Template drawing functions
        function drawCharacterBase(ctx, w, h) {
            // Simple humanoid base - front facing
            ctx.fillStyle = '#888888';

            // Head
            const headSize = Math.floor(w / 4);
            const headX = Math.floor(w / 2 - headSize / 2);
            const headY = Math.floor(h / 6);
            ctx.fillRect(headX, headY, headSize, headSize);

            // Body
            const bodyW = Math.floor(w / 3);
            const bodyH = Math.floor(h / 3);
            const bodyX = Math.floor(w / 2 - bodyW / 2);
            const bodyY = headY + headSize;
            ctx.fillRect(bodyX, bodyY, bodyW, bodyH);

            // Arms
            const armW = Math.floor(w / 8);
            const armH = Math.floor(h / 3);
            ctx.fillRect(bodyX - armW, bodyY, armW, armH); // Left arm
            ctx.fillRect(bodyX + bodyW, bodyY, armW, armH); // Right arm

            // Legs
            const legW = Math.floor(w / 6);
            const legH = Math.floor(h / 3);
            const legY = bodyY + bodyH;
            ctx.fillRect(bodyX, legY, legW, legH); // Left leg
            ctx.fillRect(bodyX + bodyW - legW, legY, legW, legH); // Right leg
        }

        function drawCharacterSide(ctx, w, h) {
            // Side view character
            ctx.fillStyle = '#888888';

            // Head (circle-ish)
            const headSize = Math.floor(w / 3.5);
            const headX = Math.floor(w / 2);
            const headY = Math.floor(h / 6);
            ctx.fillRect(headX, headY, headSize, headSize);

            // Body
            const bodyW = Math.floor(w / 3);
            const bodyH = Math.floor(h / 3);
            const bodyX = Math.floor(w / 2 - bodyW / 4);
            const bodyY = headY + headSize;
            ctx.fillRect(bodyX, bodyY, bodyW, bodyH);

            // Arm (one visible)
            const armW = Math.floor(w / 6);
            const armH = Math.floor(h / 2.5);
            ctx.fillRect(bodyX + bodyW / 2, bodyY, armW, armH);

            // Legs
            const legW = Math.floor(w / 7);
            const legH = Math.floor(h / 3);
            const legY = bodyY + bodyH;
            ctx.fillRect(bodyX + bodyW / 4, legY, legW, legH);
            ctx.fillRect(bodyX + bodyW / 2, legY, legW, legH);
        }

        function drawChibiBase(ctx, w, h) {
            // Cute chibi character (big head, small body)
            ctx.fillStyle = '#888888';

            // Big head
            const headSize = Math.floor(w / 2);
            const headX = Math.floor(w / 2 - headSize / 2);
            const headY = Math.floor(h / 8);
            ctx.fillRect(headX, headY, headSize, headSize);

            // Small body
            const bodyW = Math.floor(w / 2.5);
            const bodyH = Math.floor(h / 4);
            const bodyX = Math.floor(w / 2 - bodyW / 2);
            const bodyY = headY + headSize;
            ctx.fillRect(bodyX, bodyY, bodyW, bodyH);

            // Arms
            const armW = Math.floor(w / 10);
            const armH = Math.floor(h / 5);
            ctx.fillRect(bodyX - armW, bodyY, armW, armH);
            ctx.fillRect(bodyX + bodyW, bodyY, armW, armH);

            // Legs
            const legW = Math.floor(w / 7);
            const legH = Math.floor(h / 4);
            const legY = bodyY + bodyH;
            ctx.fillRect(bodyX + bodyW / 4 - legW / 2, legY, legW, legH);
            ctx.fillRect(bodyX + (bodyW * 3 / 4) - legW / 2, legY, legW, legH);
        }

        function drawCoin(ctx, w, h) {
            ctx.fillStyle = '#888888';
            ctx.strokeStyle = '#CCCCCC';
            ctx.lineWidth = 1;

            // Circular coin
            const radius = Math.min(w, h) / 3;
            const centerX = w / 2;
            const centerY = h / 2;

            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // Inner circle
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * 0.7, 0, Math.PI * 2);
            ctx.stroke();
        }

        function drawHeart(ctx, w, h) {
            ctx.fillStyle = '#888888';

            // Simple pixelated heart
            const size = Math.min(w, h);
            const pixel = Math.floor(size / 8);
            const startX = (w - pixel * 7) / 2;
            const startY = (h - pixel * 6) / 2;

            // Row 1
            ctx.fillRect(startX + pixel, startY, pixel, pixel);
            ctx.fillRect(startX + pixel * 2, startY, pixel, pixel);
            ctx.fillRect(startX + pixel * 4, startY, pixel, pixel);
            ctx.fillRect(startX + pixel * 5, startY, pixel, pixel);

            // Row 2
            ctx.fillRect(startX, startY + pixel, pixel * 7, pixel);

            // Row 3
            ctx.fillRect(startX, startY + pixel * 2, pixel * 7, pixel);

            // Row 4
            ctx.fillRect(startX + pixel, startY + pixel * 3, pixel * 5, pixel);

            // Row 5
            ctx.fillRect(startX + pixel * 2, startY + pixel * 4, pixel * 3, pixel);

            // Row 6
            ctx.fillRect(startX + pixel * 3, startY + pixel * 5, pixel, pixel);
        }

        function drawSword(ctx, w, h) {
            ctx.fillStyle = '#888888';
            ctx.strokeStyle = '#CCCCCC';
            ctx.lineWidth = 1;

            // Blade
            const bladeW = Math.floor(w / 6);
            const bladeH = Math.floor(h * 0.6);
            const bladeX = Math.floor(w / 2 - bladeW / 2);
            const bladeY = Math.floor(h * 0.1);
            ctx.fillRect(bladeX, bladeY, bladeW, bladeH);

            // Guard
            const guardW = Math.floor(w / 2);
            const guardH = Math.floor(h / 12);
            const guardX = Math.floor(w / 2 - guardW / 2);
            const guardY = bladeY + bladeH;
            ctx.fillRect(guardX, guardY, guardW, guardH);

            // Handle
            const handleW = Math.floor(w / 8);
            const handleH = Math.floor(h / 5);
            const handleX = Math.floor(w / 2 - handleW / 2);
            const handleY = guardY + guardH;
            ctx.fillRect(handleX, handleY, handleW, handleH);

            // Pommel
            const pommelSize = Math.floor(w / 5);
            const pommelX = Math.floor(w / 2 - pommelSize / 2);
            const pommelY = handleY + handleH;
            ctx.fillRect(pommelX, pommelY, pommelSize, pommelSize);
        }

        function drawPotion(ctx, w, h) {
            ctx.fillStyle = '#888888';
            ctx.strokeStyle = '#CCCCCC';
            ctx.lineWidth = 1;

            // Cork/stopper
            const corkW = Math.floor(w / 4);
            const corkH = Math.floor(h / 8);
            const corkX = Math.floor(w / 2 - corkW / 2);
            const corkY = Math.floor(h / 8);
            ctx.fillRect(corkX, corkY, corkW, corkH);

            // Neck
            const neckW = Math.floor(w / 3);
            const neckH = Math.floor(h / 6);
            const neckX = Math.floor(w / 2 - neckW / 2);
            const neckY = corkY + corkH;
            ctx.fillRect(neckX, neckY, neckW, neckH);

            // Body (bottle)
            const bodyW = Math.floor(w / 1.5);
            const bodyH = Math.floor(h / 2);
            const bodyX = Math.floor(w / 2 - bodyW / 2);
            const bodyY = neckY + neckH;
            ctx.fillRect(bodyX, bodyY, bodyW, bodyH);

            // Liquid inside (lighter)
            ctx.fillStyle = '#AAAAAA';
            const liquidH = Math.floor(bodyH * 0.7);
            ctx.fillRect(bodyX + 2, bodyY + bodyH - liquidH, bodyW - 4, liquidH - 2);
        }

        function drawChest(ctx, w, h) {
            ctx.fillStyle = '#888888';
            ctx.strokeStyle = '#CCCCCC';
            ctx.lineWidth = 1;

            // Main chest box
            const chestW = Math.floor(w * 0.7);
            const chestH = Math.floor(h * 0.5);
            const chestX = Math.floor(w / 2 - chestW / 2);
            const chestY = Math.floor(h / 2.5);
            ctx.fillRect(chestX, chestY, chestW, chestH);
            ctx.strokeRect(chestX, chestY, chestW, chestH);

            // Lid
            const lidH = Math.floor(h * 0.3);
            ctx.fillRect(chestX, chestY - lidH, chestW, lidH);
            ctx.strokeRect(chestX, chestY - lidH, chestW, lidH);

            // Lock
            const lockSize = Math.floor(Math.min(w, h) / 6);
            const lockX = Math.floor(w / 2 - lockSize / 2);
            const lockY = chestY + chestH / 3;
            ctx.fillStyle = '#CCCCCC';
            ctx.fillRect(lockX, lockY, lockSize, lockSize);
        }

        function drawKey(ctx, w, h) {
            ctx.fillStyle = '#888888';

            // Head (circle)
            const headSize = Math.floor(h / 3);
            const headX = Math.floor(w / 4);
            const headY = Math.floor(h / 2 - headSize / 2);
            ctx.fillRect(headX, headY, headSize, headSize);

            // Hole in head
            ctx.fillStyle = '#1a1a1a';
            const holeSize = Math.floor(headSize / 3);
            const holeX = headX + headSize / 2 - holeSize / 2;
            const holeY = headY + headSize / 2 - holeSize / 2;
            ctx.fillRect(holeX, holeY, holeSize, holeSize);

            // Shaft
            ctx.fillStyle = '#888888';
            const shaftW = Math.floor(w / 2);
            const shaftH = Math.floor(h / 8);
            const shaftX = headX + headSize;
            const shaftY = Math.floor(h / 2 - shaftH / 2);
            ctx.fillRect(shaftX, shaftY, shaftW, shaftH);

            // Teeth
            const toothW = Math.floor(w / 12);
            const toothH = Math.floor(h / 6);
            ctx.fillRect(shaftX + shaftW - toothW * 3, shaftY + shaftH, toothW, toothH);
            ctx.fillRect(shaftX + shaftW - toothW, shaftY + shaftH, toothW, toothH);
        }

        function drawButton(ctx, w, h) {
            ctx.fillStyle = '#888888';
            ctx.strokeStyle = '#CCCCCC';
            ctx.lineWidth = 2;

            // Rounded rectangle button
            const margin = 4;
            const cornerSize = 6;

            ctx.fillRect(margin + cornerSize, margin, w - margin * 2 - cornerSize * 2, h - margin * 2);
            ctx.fillRect(margin, margin + cornerSize, w - margin * 2, h - margin * 2 - cornerSize * 2);

            // Corners
            ctx.fillRect(margin, margin, cornerSize, cornerSize);
            ctx.fillRect(w - margin - cornerSize, margin, cornerSize, cornerSize);
            ctx.fillRect(margin, h - margin - cornerSize, cornerSize, cornerSize);
            ctx.fillRect(w - margin - cornerSize, h - margin - cornerSize, cornerSize, cornerSize);

            ctx.strokeRect(margin, margin, w - margin * 2, h - margin * 2);
        }

        // Template data with drawing functions
        const templates = [
            // Characters
            { name: 'Character Front', width: 32, height: 32, category: 'Characters', draw: drawCharacterBase },
            { name: 'Character Side', width: 32, height: 32, category: 'Characters', draw: drawCharacterSide },
            { name: 'Chibi Character', width: 32, height: 32, category: 'Characters', draw: drawChibiBase },
            { name: 'Character Front 64x64', width: 64, height: 64, category: 'Characters', draw: drawCharacterBase },

            // Items
            { name: 'Coin', width: 24, height: 24, category: 'Items', draw: drawCoin },
            { name: 'Heart', width: 24, height: 24, category: 'Items', draw: drawHeart },
            { name: 'Sword', width: 24, height: 32, category: 'Items', draw: drawSword },
            { name: 'Potion Bottle', width: 24, height: 32, category: 'Items', draw: drawPotion },
            { name: 'Treasure Chest', width: 32, height: 32, category: 'Items', draw: drawChest },
            { name: 'Key', width: 32, height: 24, category: 'Items', draw: drawKey },

            // UI Elements
            { name: 'Button Small', width: 64, height: 32, category: 'UI Elements', draw: drawButton },
            { name: 'Button Medium', width: 100, height: 40, category: 'UI Elements', draw: drawButton },
            { name: 'Icon 16x16', width: 16, height: 16, category: 'UI Elements', draw: drawHeart },

            // Special
            { name: 'Full Screen', width: 480, height: 320, category: 'Backgrounds', draw: (ctx, w, h) => {
                ctx.fillStyle = '#888888';
                ctx.strokeStyle = '#CCCCCC';
                ctx.lineWidth = 4;
                ctx.strokeRect(2, 2, w - 4, h - 4);
                ctx.fillStyle = '#AAAAAA';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('480x320', w / 2, h / 2);
            }}
        ];

        // Initialize templates
        function initTemplates() {
            const grid = document.getElementById('templateGrid');

            // Group templates by category
            const categories = {};
            templates.forEach(template => {
                if (!categories[template.category]) {
                    categories[template.category] = [];
                }
                categories[template.category].push(template);
            });

            // Add category headers and templates
            Object.keys(categories).forEach(category => {
                const categoryHeader = document.createElement('div');
                categoryHeader.style.gridColumn = '1 / -1';
                categoryHeader.style.marginTop = '20px';
                categoryHeader.innerHTML = `<h3 style="color: #39FF14; font-size: 1.2em; margin-bottom: 10px;">${category}</h3>`;
                grid.appendChild(categoryHeader);

                categories[category].forEach(template => {
                    const item = document.createElement('div');
                    item.className = 'template-item';

                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'template-preview';

                    const canvas = document.createElement('canvas');
                    canvas.width = template.width;
                    canvas.height = template.height;
                    const ctx = canvas.getContext('2d');

                    // Clear background
                    ctx.fillStyle = '#1a1a1a';
                    ctx.fillRect(0, 0, template.width, template.height);

                    // Draw the actual template artwork
                    template.draw(ctx, template.width, template.height);

                    previewDiv.appendChild(canvas);

                    const title = document.createElement('h3');
                    title.textContent = template.name;

                    const desc = document.createElement('p');
                    desc.textContent = `${template.width}√ó${template.height} px`;

                    const downloadBtn = document.createElement('button');
                    downloadBtn.className = 'btn btn-primary';
                    downloadBtn.textContent = 'Download';
                    downloadBtn.style.width = '100%';
                    downloadBtn.onclick = () => downloadTemplate(canvas, template.name);

                    item.appendChild(previewDiv);
                    item.appendChild(title);
                    item.appendChild(desc);
                    item.appendChild(downloadBtn);
                    grid.appendChild(item);
                });
            });
        }

        function downloadTemplate(canvas, name) {
            const link = document.createElement('a');
            link.download = `${name.replace(/\s+/g, '_')}_template.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                processImage(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                processImage(e.target.files[0]);
            }
        });

        function processImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    if (img.width > 480 || img.height > 320) {
                        alert('Warning: Image exceeds display size (480x320). Consider resizing for optimal performance.');
                    }

                    displayImage(img);
                    convertToRGB565(img);

                    document.getElementById('previewSection').style.display = 'block';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function displayImage(img) {
            const canvas = document.getElementById('originalCanvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);

            currentImageData = ctx.getImageData(0, 0, img.width, img.height);

            // Display image info
            const infoBox = document.getElementById('imageInfo');
            const colorCount = getUniqueColorCount(currentImageData);
            infoBox.innerHTML = `
                <p><strong>Dimensions:</strong> ${img.width} √ó ${img.height} pixels</p>
                <p><strong>Total Pixels:</strong> ${img.width * img.height}</p>
                <p><strong>Unique Colors:</strong> ${colorCount}</p>
                <p><strong>Memory Size:</strong> ${(img.width * img.height * 2)} bytes (${((img.width * img.height * 2) / 1024).toFixed(2)} KB)</p>
            `;
        }

        function getUniqueColorCount(imageData) {
            const colors = new Set();
            for (let i = 0; i < imageData.data.length; i += 4) {
                const r = imageData.data[i];
                const g = imageData.data[i + 1];
                const b = imageData.data[i + 2];
                colors.add(`${r},${g},${b}`);
            }
            return colors.size;
        }

        function convertToRGB565(img) {
            const canvas = document.getElementById('rgb565Canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = img.width;
            tempCanvas.height = img.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(img, 0, 0);

            const imageData = tempCtx.getImageData(0, 0, img.width, img.height);
            const rgb565Array = [];

            for (let i = 0; i < imageData.data.length; i += 4) {
                let r = imageData.data[i];
                let g = imageData.data[i + 1];
                let b = imageData.data[i + 2];
                const a = imageData.data[i + 3];

                // Handle transparency - convert to white
                if (a < 128) {
                    r = 255;
                    g = 255;
                    b = 255;
                }

                // Convert to RGB565
                const r5 = (r >> 3) & 0x1F;
                const g6 = (g >> 2) & 0x3F;
                const b5 = (b >> 3) & 0x1F;
                const rgb565 = (r5 << 11) | (g6 << 5) | b5;

                rgb565Array.push(rgb565);

                // Convert back to RGB888 for preview
                imageData.data[i] = (r5 << 3) | (r5 >> 2);
                imageData.data[i + 1] = (g6 << 2) | (g6 >> 4);
                imageData.data[i + 2] = (b5 << 3) | (b5 >> 2);
                imageData.data[i + 3] = 255;
            }

            ctx.putImageData(imageData, 0, 0);
            currentRGB565Data = {
                width: img.width,
                height: img.height,
                data: rgb565Array,
                imageData: imageData
            };
        }

        document.getElementById('generateBtn').addEventListener('click', () => {
            if (!currentRGB565Data) return;

            const spriteName = document.getElementById('spriteName').value || 'sprite';
            const code = generateCCode(spriteName, currentRGB565Data);

            document.getElementById('codeText').textContent = code;
            document.getElementById('codeOutput').style.display = 'block';
        });

        function generateCCode(name, rgb565Data) {
            const sanitizedName = name.replace(/[^a-zA-Z0-9_]/g, '_');
            let code = `// ${sanitizedName} - ${rgb565Data.width}x${rgb565Data.height} pixels\n`;
            code += `// Generated by ESP32 Sprite Converter\n\n`;
            code += `const uint16_t ${sanitizedName}[] PROGMEM = {\n`;

            const perLine = 12;
            for (let i = 0; i < rgb565Data.data.length; i++) {
                if (i % perLine === 0) code += '  ';
                code += `0x${rgb565Data.data[i].toString(16).toUpperCase().padStart(4, '0')}`;
                if (i < rgb565Data.data.length - 1) code += ',';
                if ((i + 1) % perLine === 0 && i < rgb565Data.data.length - 1) {
                    code += '\n';
                } else if (i < rgb565Data.data.length - 1) {
                    code += ' ';
                }
            }

            code += `\n};\n\n`;
            code += `const int ${sanitizedName}_width = ${rgb565Data.width};\n`;
            code += `const int ${sanitizedName}_height = ${rgb565Data.height};\n\n`;
            code += `// Usage example:\n`;
            code += `// sprite.pushImage(x, y, ${sanitizedName}_width, ${sanitizedName}_height, ${sanitizedName});`;

            return code;
        }

        document.getElementById('copyCodeBtn').addEventListener('click', () => {
            const code = document.getElementById('codeText').textContent;
            navigator.clipboard.writeText(code).then(() => {
                const btn = document.getElementById('copyCodeBtn');
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                setTimeout(() => btn.textContent = originalText, 2000);
            });
        });

        document.getElementById('saveToGalleryBtn').addEventListener('click', () => {
            if (!currentRGB565Data) return;

            const spriteName = document.getElementById('spriteName').value || `sprite_${Date.now()}`;

            const gallery = JSON.parse(localStorage.getItem('spriteGallery') || '[]');

            gallery.push({
                name: spriteName,
                width: currentRGB565Data.width,
                height: currentRGB565Data.height,
                data: currentRGB565Data.data,
                imageDataURL: document.getElementById('rgb565Canvas').toDataURL(),
                timestamp: Date.now()
            });

            localStorage.setItem('spriteGallery', JSON.stringify(gallery));

            alert('Sprite saved to gallery!');

            // Switch to gallery tab
            document.querySelector('[data-tab="gallery"]').click();
        });

        function loadGallery() {
            const gallery = JSON.parse(localStorage.getItem('spriteGallery') || '[]');
            const container = document.getElementById('galleryContent');

            if (gallery.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>No sprites yet</h3>
                        <p>Convert and save your first sprite to see it here!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '<div class="gallery-grid"></div>';
            const grid = container.querySelector('.gallery-grid');

            gallery.forEach((sprite, index) => {
                const item = document.createElement('div');
                item.className = 'gallery-item';

                const img = document.createElement('img');
                img.src = sprite.imageDataURL;

                const info = document.createElement('div');
                info.className = 'gallery-item-info';
                info.innerHTML = `
                    <strong>${sprite.name}</strong><br>
                    ${sprite.width}√ó${sprite.height} px<br>
                    ${new Date(sprite.timestamp).toLocaleDateString()}
                `;

                const actions = document.createElement('div');
                actions.className = 'gallery-actions';

                const viewCodeBtn = document.createElement('button');
                viewCodeBtn.className = 'btn btn-primary';
                viewCodeBtn.textContent = 'View Code';
                viewCodeBtn.onclick = () => viewSpriteCode(sprite);

                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'btn btn-secondary';
                downloadBtn.textContent = 'Download';
                downloadBtn.onclick = () => downloadSprite(sprite);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteSprite(index);

                actions.appendChild(viewCodeBtn);
                actions.appendChild(downloadBtn);
                actions.appendChild(deleteBtn);

                item.appendChild(img);
                item.appendChild(info);
                item.appendChild(actions);
                grid.appendChild(item);
            });
        }

        function viewSpriteCode(sprite) {
            const code = generateCCode(sprite.name, sprite);

            const modal = document.createElement('div');
            modal.className = 'modal';

            const content = document.createElement('div');
            content.className = 'modal-content';

            content.innerHTML = `
                <div class="modal-header">
                    <h2>${sprite.name}</h2>
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                </div>
                <button class="btn btn-primary" style="margin-bottom: 15px;" onclick="navigator.clipboard.writeText(this.nextElementSibling.textContent).then(() => { this.textContent = '‚úì Copied!'; setTimeout(() => this.textContent = 'Copy Code', 2000); })">Copy Code</button>
                <div class="code-output">${code}</div>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        function downloadSprite(sprite) {
            const link = document.createElement('a');
            link.download = `${sprite.name}.png`;
            link.href = sprite.imageDataURL;
            link.click();
        }

        function deleteSprite(index) {
            if (confirm('Are you sure you want to delete this sprite?')) {
                const gallery = JSON.parse(localStorage.getItem('spriteGallery') || '[]');
                gallery.splice(index, 1);
                localStorage.setItem('spriteGallery', JSON.stringify(gallery));
                loadGallery();
            }
        }

        // Initialize on load
        initTemplates();
    </script>
</body>
</html>
